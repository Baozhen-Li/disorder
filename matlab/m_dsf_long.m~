
function DSF = m_dsf_long( str , kpt , x0 , freqp, eigvec, alat , heav_fac )
%M_DSF_LONG
%	DSF = m_dsf_long( str , kpt , x0 , freqp, eigvec, alat , heav_fac )
%	
%	kpt is expected to have form:
%
%	kpt(:,1) = 0...0.5
%	x0(:,1)==atomid, x0(:,2)==typeid, x0(:,3:5)=xyz
%	freq(1:NUM_MODES)
%	eigvec(3*NUM_ATOMS,NUM_MODES)
%--------------------------------------------------------------------------
tic
%--------------------------------------------------------------------------

lj = m_lj; constant = m_constant;

KX = kpt(:,1)/alat;
Inan = find(isnan(KX)==1); KX(Inan)=0;
KY = kpt(:,2)/alat;
Inan = find(isnan(KY)==1); KY(Inan)=0;
KZ = kpt(:,3)/alat;
Inan = find(isnan(KZ)==1); KZ(Inan)=0;

for imode = 1:size(freqp,1)
    
spatialx =...
    bsxfun( @times , x0(:,3) , ...
    KX' );
spatialy =...
    bsxfun( @times , x0(:,4) , ...
    KY' );
spatialz =...
    bsxfun( @times , x0(:,5) , ...
    KZ' );

eig_fftx(imode,1:size(kpt,1)) =...
    sum(...
    bsxfun(...
    @times ,...
    bsxfun(@times,exp( 2*pi*1i*(spatialx + spatialy +spatialz)),KX') ,...
    eigvec(1:3:size(eigvec,1),imode) )...
    , 1);

eig_ffty(imode,1:size(kpt,1)) =...
    sum(...
    bsxfun(...
    @times ,...
    bsxfun(@times,exp( 2*pi*1i*(spatialx + spatialy +spatialz)),KY') ,...
    eigvec(2:3:size(eigvec,1),imode) )...
    , 1);

eig_fftz(imode,1:size(kpt,1)) =...
    sum(...
    bsxfun(...
    @times ,...
    bsxfun(@times,exp( 2*pi*1i*(spatialx + spatialy +spatialz)),KZ') ,...
    eigvec(3:3:size(eigvec,1),imode) )...
    , 1);

EpL(imode,:) =...
    real(eig_fftx(imode,:)).^2 + imag(eig_fftx(imode,:)).^2 +...
    real(eig_ffty(imode,:)).^2 + imag(eig_ffty(imode,:)).^2 +...
    real(eig_fftz(imode,:)).^2 + imag(eig_fftz(imode,:)).^2 ; 

%--------------------------------------------------------------------------
%pause
%--------------------------------------------------------------------------

end

DSF.freq_range = linspace( 0 , max(freqp) , size(freqp,1) );

for imode = 1:size(freqp,1)

SL(imode,:) = ...
    
    sum(...
    bsxfun(@times,...
    EpL(:,:) ,...
    heaviside(...
    heav_fac -...
    abs( (DSF.freq_range(imode) - freqp) ./ DSF.freq_range(imode) )...
    )...
    ),...
    1);

% size(heaviside(...
%     heav_fac -...
%     abs( (DSF.freq_range(imode) - freqp) ./ DSF.freq_range(imode) )...
%     ))
% 
% size(EpL(:,:))
% 
% size(bsxfun(@times,...
%     EpL(:,:) ,...
%     heaviside(...
%     heav_fac -...
%     abs( (DSF.freq_range(imode) - freqp) ./ DSF.freq_range(imode) )...
%     )...
%     ))
% 
% size(SL(:,:))
% 
% EpL(1:10,:)
% 
% pause

end

DSF.kpt = kpt;
DSF.SL = SL;
DSF.freq = freqp;

save(strcat(str,'DSF_long.mat'), '-struct', 'DSF');
%--------------------------------------------------------------------------
toc
%--------------------------------------------------------------------------
end




